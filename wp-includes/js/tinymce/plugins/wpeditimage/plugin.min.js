tinymce.PluginManager.add("wpeditimage",function(g){var t,s=!1;function e(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,a){var n,i,o,d,s=tinymce.trim,c=t.match(/id=['"]([^'"]*)['"] ?/);return(d=(t=(n=(t=c?t.replace(c[0],""):t).match(/align=['"]([^'"]*)['"] ?/))?t.replace(n[0],""):t).match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(d[0],"")),o=(o=(a=s(a)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&o[2]?(i=s(o[2]),s(o[1])):(i=s(t).replace(/caption=['"]/,"").replace(/['"]$/,""),a),c=c&&c[1]?c[1]:"",n=n&&n[1]?n[1]:"alignnone",(d=(d=!d&&o?o.match(/width=['"]([0-9]*)['"]/):d)&&d[1]?d[1]:d)&&i?(d=parseInt(d,10),g.getParam("wpeditimage_html5_captions")||(d+=10),'<div class="mceTemp"><dl id="'+c+'" class="wp-caption '+n+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+o+'</dt><dd class="wp-caption-dd">'+i+"</dd></dl></div>"):a})}function a(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var a="";return-1===t.indexOf("<img ")?(a=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i))&&a[1]?"<p>"+a[1]+"</p>":"":0!==(a=t.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(e,t,a,n){var i,o=a.match(/width="([0-9]*)"/);return(o=o&&o[1]?o[1]:"")&&n?'[caption id="'+(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"")+'" align="'+(t=(t=(t=t.match(/class="([^"]*)"/))&&t[1]?t[1]:"").match(/align[a-z]+/)||"alignnone")+'" width="'+o+'"]'+a+" "+(n=(n=n.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]":a})).indexOf("[caption")?t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"):a})}function p(e){return e&&(e.textContent||e.innerText)}function u(e){return!e||-1===e.indexOf("<")&&-1===e.indexOf(">")?e:(t=t||new tinymce.html.Serializer({},g.schema)).serialize(g.parser.parse(e,{forced_root_block:!1}))}function n(m){var e,t,a,n,i,o,d,s;"undefined"!=typeof wp&&wp.media?(t=m,o=g.dom,(s={attachment_id:!(d=/^\d+$/),size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=o.getAttrib(t,"src"),s.alt=o.getAttrib(t,"alt"),s.title=o.getAttrib(t,"title"),n=o.getAttrib(t,"width"),i=o.getAttrib(t,"height"),(!d.test(n)||parseInt(n,10)<1)&&(n=t.naturalWidth||t.width),(!d.test(i)||parseInt(i,10)<1)&&(i=t.naturalHeight||t.height),s.customWidth=s.width=n,s.customHeight=s.height=i,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?s.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?s.align=e.replace("align",""):/^size/.test(e)?s.size=e.replace("size-",""):a.push(e)}),s.extraClasses=a.join(" "),(i=o.getParents(t,".wp-caption")).length&&(n=(i=i[0]).className.split(" "),tinymce.each(n,function(e){/^align/.test(e)&&(s.align=e.replace("align",""))}),(i=o.select("dd.wp-caption-dd",i)).length&&(i=i[0],s.caption=g.serializer.serialize(i).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(t=t.parentNode,s.linkUrl=o.getAttrib(t,"href"),s.linkTargetBlank="_blank"===o.getAttrib(t,"target"),s.linkRel=o.getAttrib(t,"rel"),s.linkClassName=t.className),t=s,wp.media.events.trigger("editor:image-edit",{editor:g,metadata:t,image:m}),e=wp.media({frame:"image",state:"image-details",metadata:t}),wp.media.events.trigger("editor:frame-create",{frame:e}),t=function(l){g.focus(),g.undoManager.transact(function(){var e,t,a,n,i,o,d,s,c,r;e=m,t=l,c=g.dom,r=(r=tinymce.explode(t.extraClasses," "))||[],t.caption||r.push("align"+t.align),t.attachment_id&&(r.push("wp-image-"+t.attachment_id),t.size&&"custom"!==t.size&&r.push("size-"+t.size)),d=t.width,s=t.height,"custom"===t.size&&(d=t.customWidth,s=t.customHeight),i={src:t.url,width:d||null,height:s||null,alt:t.alt,title:t.title||null,"class":r.join(" ")||null},c.setAttribs(e,i),o={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,"class":t.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!p(e.parentNode)?t.linkUrl?c.setAttribs(e.parentNode,o):c.remove(e.parentNode,!0):t.linkUrl&&((n=c.getParent(e,"a"))&&c.insertAfter(e,n),n=c.create("a",o),e.parentNode.insertBefore(n,e),n.appendChild(e)),s=g.dom.getParent(e,".mceTemp"),r=e.parentNode&&"A"===e.parentNode.nodeName&&!p(e.parentNode)?e.parentNode:e,t.caption?(t.caption=u(t.caption),i=t.attachment_id?"attachment_"+t.attachment_id:null,o="wp-caption align"+(t.align||"none"),g.getParam("wpeditimage_html5_captions")||(d=parseInt(d,10),d+=10),s?((n=c.select("dl.wp-caption",s)).length&&c.setAttribs(n,{id:i,"class":o,style:"width: "+d+"px"}),(n=c.select(".wp-caption-dd",s)).length&&c.setHTML(n[0],t.caption)):(o="<dl "+(i=i?'id="'+i+'" ':"")+'class="'+o+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+c.getOuterHTML(r)+'</dt><dd class="wp-caption-dd">'+t.caption+"</dd></dl>",(a=c.getParent(r,"p"))?(d=c.create("div",{"class":"mceTemp"},o),a.parentNode.insertBefore(d,a),c.remove(r),c.isEmpty(a)&&c.remove(a)):c.setOuterHTML(r,'<div class="mceTemp">'+o+"</div>"))):s&&(a=c.create("p"),s.parentNode.insertBefore(a,s),a.appendChild(r),c.remove(s)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:g,metadata:t,image:e}),g.nodeChanged(),h(e)}),e.detach()},e.state("image-details").on("update",t),e.state("replace-image").on("replace",t),e.on("close",function(){g.focus(),e.detach()}),e.open()):g.execCommand("mceImage")}function c(e){var t;"DIV"===e.nodeName&&g.dom.hasClass(e,"mceTemp")?t=e:"IMG"!==e.nodeName&&"DT"!==e.nodeName&&"A"!==e.nodeName||(t=g.dom.getParent(e,"div.mceTemp")),t?(t.nextSibling?g.selection.select(t.nextSibling):t.previousSibling?g.selection.select(t.previousSibling):g.selection.select(t.parentNode),g.selection.collapse(!0),g.nodeChanged(),g.dom.remove(t)):g.dom.remove(e),r()}function h(e){var t,a,n=g.dom;r(),e&&"IMG"===e.nodeName&&!i(e)&&(n.setAttrib(e,"data-wp-imgselect",1),t=n.getRect(e),a=n.create("div",{id:"wp-image-toolbar","data-mce-bogus":"1",contenteditable:!1},'<div class="dashicons dashicons-edit edit" data-mce-bogus="1"></div><div class="dashicons dashicons-no-alt remove" data-mce-bogus="1"></div>'),e=g.rtl?t.x+t.w-82:t.x,g.getBody().appendChild(a),n.setStyles(a,{top:t.y,left:e}),s=!0)}function r(){var e=g.dom.get("wp-image-toolbar");e&&g.dom.remove(e),g.dom.setAttrib(g.dom.select("img[data-wp-imgselect]"),"data-wp-imgselect",null),s=!1}function i(e){var t=g.dom;return!!(t.hasClass(e,"mceItem")||t.getAttrib(e,"data-mce-placeholder")||t.getAttrib(e,"data-mce-object"))}return g.on("init",function(){var p=g.dom,e=g.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";p.addClass(g.getBody(),e),g.on("wpLoadImageForm",function(e){g.getParam("wpeditimage_disable_captions")||e.data.splice(e.data.length-1,0,{type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})}),g.on("wpNewImageRefresh",function(e){var t;(t=p.getParent(e.node,"dl.wp-caption"))&&(t.style.width||(e=(e=parseInt(e.node.clientWidth,10)+10)?e+"px":"50%",p.setStyle(t,"width",e)))}),g.on("wpImageFormSubmit",function(e){var t,a,n,i,o,d=e.imgData.data,s=e.imgData.node,c=e.imgData.caption,r="",l="",m="";d.id="__wp-temp-img-id",e.imgData.cancel=!0,d.style||(d.style=null),d.src?(c=c&&u(c=(c=c.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />")),s?(o=s.id||null,p.setAttribs(s,d),t=p.getParent(s,"dl.wp-caption"),c?t?(a=p.select("dd.wp-caption-dd",t)[0])&&(a.innerHTML=c):(s.className&&(r=s.className.match(/wp-image-([0-9]+)/),l=s.className.match(/align(left|right|center|none)/)),l?(l=l[0],s.className=s.className.replace(/align(left|right|center|none)/g,"")):l="alignnone",l=' class="wp-caption '+l+'"',r=r&&' id="attachment_'+r[1]+'"',(m=d.width||s.clientWidth)&&(m=parseInt(m,10),g.getParam("wpeditimage_html5_captions")||(m+=10),m=' style="width: '+m+'px"'),n=s.parentNode&&"A"===s.parentNode.nodeName?(i=p.getOuterHTML(s.parentNode),s.parentNode):(i=p.getOuterHTML(s),s),i="<dl "+r+l+m+'><dt class="wp-caption-dt">'+i+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl>",(a=p.getParent(s,"p"))?(t=p.create("div",{"class":"mceTemp"},i),p.insertAfter(t,a),g.selection.select(t),g.nodeChanged(),p.remove(n),p.isEmpty(a)&&p.remove(a)):g.selection.setContent('<div class="mceTemp">'+i+"</div>")):t&&(i="A"===s.parentNode.nodeName?p.getOuterHTML(s.parentNode):p.getOuterHTML(s),a=p.create("p",{},i),p.insertAfter(a,t.parentNode),g.selection.select(a),g.nodeChanged(),p.remove(t.parentNode))):(i=p.createHTML("img",d),c?(n=g.selection.getNode(),d.width&&(m=parseInt(d.width,10),g.getParam("wpeditimage_html5_captions")||(m+=10),m=' style="width: '+m+'px"'),i='<dl class="wp-caption alignnone"'+m+'><dt class="wp-caption-dt">'+i+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl>",(a="P"===n.nodeName?n:p.getParent(n,"p"))&&"P"===a.nodeName?(t=p.create("div",{"class":"mceTemp"},i),a.parentNode.insertBefore(t,a),g.selection.select(t),g.nodeChanged(),p.isEmpty(a)&&p.remove(a)):g.selection.setContent('<div class="mceTemp">'+i+"</div>")):g.selection.setContent(i)),s=p.get("__wp-temp-img-id"),p.setAttrib(s,"id",o),e.imgData.node=s):s&&((t=p.getParent(s,"div.mceTemp"))?p.remove(t):"A"===s.parentNode.nodeName?p.remove(s.parentNode):p.remove(s),g.nodeChanged())}),g.on("wpLoadImageData",function(e){var t=e.imgData.data,e=e.imgData.node;(e=p.getParent(e,"dl.wp-caption"))&&(e=p.select("dd.wp-caption-dd",e)[0])&&(t.caption=g.serializer.serialize(e).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),p.bind(g.getDoc(),"dragstart",function(e){var t=g.selection.getNode();"IMG"===t.nodeName&&p.getParent(t,".wp-caption")&&e.preventDefault(),r()}),tinymce.Env.ie&&10<tinymce.Env.ie&&(p.bind(g.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&p.getParent(e.target,".wp-caption")?g.getBody().focus():"DL"===e.target.nodeName&&p.hasClass(e.target,"wp-caption")&&e.target.focus()}),g.on("click",function(e){"IMG"===e.target.nodeName&&p.getAttrib(e.target,"data-wp-imgselect")&&p.getParent(e.target,"dl.wp-caption")&&g.getBody().focus()}))}),g.on("ObjectResized",function(e){var t,a,n=e.target,i=g.dom;"IMG"===n.nodeName&&(n.className=n.className.replace(/\bsize-[^ ]+/,""),(t=i.getParent(n,".wp-caption"))&&(a=e.width||i.getAttrib(n,"width"))&&(a=parseInt(a,10),g.getParam("wpeditimage_html5_captions")||(a+=10),i.setStyle(t,"width",a+"px")),h(n))}),g.on("BeforeExecCommand",function(e){var t,a,n,i=e.command,o=g.dom;if("mceInsertContent"===i){if((t=o.getParent(g.selection.getNode(),"div.mceTemp"))&&(a=o.create("p"),o.insertAfter(a,t),g.selection.setCursorLocation(a,0),g.nodeChanged(),8<tinymce.Env.ie))return setTimeout(function(){g.selection.setCursorLocation(a,0),g.selection.setContent(e.value)},500),!1}else if("JustifyLeft"===i||"JustifyRight"===i||"JustifyCenter"===i){if(t=g.selection.getNode(),n="align"+i.substr(7).toLowerCase(),r(),i=o.is(t,"dl.wp-caption")?t:o.getParent(t,"dl.wp-caption"))return o.hasClass(i,n)?(o.removeClass(i,n),o.addClass(i,"alignnone")):(i.className=i.className.replace(/align[^ ]+/g,""),o.addClass(i,n)),!1;"IMG"===t.nodeName&&(o.hasClass(t,n)?o.addClass(t,"alignnone"):o.removeClass(t,"alignnone"))}}),g.on("keydown",function(e){var t,a,n,i=g.selection,o=e.keyCode,d=g.dom;if(o===tinymce.util.VK.ENTER)t=i.getNode(),(a=d.getParent(t,"div.mceTemp"))&&(d.events.cancel(e),tinymce.each(d.select("dt, dd",a),function(e){d.isEmpty(e)&&d.remove(e)}),n=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',n=d.create("p",null,n),"DD"===t.nodeName?d.insertAfter(n,a):a.parentNode.insertBefore(n,a),g.nodeChanged(),i.setCursorLocation(n,0));else if(o===tinymce.util.VK.DELETE||o===tinymce.util.VK.BACKSPACE){if("DIV"===(t=i.getNode()).nodeName&&d.hasClass(t,"mceTemp")?a=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(a=d.getParent(t,"div.mceTemp")),a)return d.events.cancel(e),c(t),!1;r()}s&&(e.ctrlKey||e.metaKey||e.altKey||o<48&&90<o||186<o||r())}),g.on("mousedown",function(e){g.dom.getParent(e.target,"#wp-image-toolbar")?tinymce.Env.ie&&e.preventDefault():"IMG"!==e.target.nodeName&&r()}),g.on("mouseup",function(e){var t=e.target,a=g.dom;e.button&&1<e.button||("DIV"===t.nodeName&&a.getParent(t,"#wp-image-toolbar")?(e=a.select("img[data-wp-imgselect]")[0])&&(g.selection.select(e),a.hasClass(t,"remove")?c(e):a.hasClass(t,"edit")&&n(e)):"IMG"!==t.nodeName||g.dom.getAttrib(t,"data-wp-imgselect")||i(t)?"IMG"!==t.nodeName&&r():h(t))}),g.on("cut",function(){r()}),g.wpSetImgCaption=e,g.wpGetImgCaption=a,g.on("BeforeSetContent",function(e){e.content=g.wpSetImgCaption(e.content)}),g.on("PostProcess",function(e){e.get&&(e.content=g.wpGetImgCaption(e.content),e.content=e.content.replace(/ data-wp-imgselect="1"/g,""))}),{_do_shcode:e,_get_shcode:a}});